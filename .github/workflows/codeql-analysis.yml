# 文件路径: .github/workflows/codeql-analysis.yml
# 修正了 upload-artifact 版本的最终版

name: "CodeQL Feature Extraction"

on:
  workflow_dispatch:

jobs:
  extract-features:
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    # 步骤1: 检出代码
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: '50eed9b008e7eff012e788a8a328901f68373579'

    # 步骤2: 初始化CodeQL
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        queries: ./.github/codeql-queries

    # 步骤3: 安装依赖
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libssl-dev protobuf-compiler libgflags-dev

    # 步骤4: 编译项目
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    # 步骤5: 运行CodeQL分析
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        output: ../results
        format: csv

    # 步骤6: 上传结果 (核心修改点)
    - name: Upload results as an artifact
      # ==========================================================
      #   已将版本从 v3 更新为 v4
      uses: actions/upload-artifact@v4
      # ==========================================================
      with:
        name: codeql-feature-results
        path: ../results
