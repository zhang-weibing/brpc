name: "CodeQL Feature Extraction"

on:
  workflow_dispatch:

jobs:
  extract-features:
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    # 步骤1: 检出包含工作流和查询文件的最新代码
    - name: Checkout workflow files
      uses: actions/checkout@v4
      with:
        path: 'workflow_repo'
        sparse-checkout: |
          .github/workflows
          .github/codeql-queries
    
    # 步骤2: 将旧版本的源代码检出到单独的目录中
    - name: Checkout target source code
      uses: actions/checkout@v4
      with:
        ref: '50eed9b008e7eff012e788a8a328901f68373579'
        path: 'source_code'

    # 步骤3: 初始化CodeQL
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        queries: ./workflow_repo/.github/codeql-queries
        source-root: source_code
        
    # 步骤4: 安装依赖 (核心修改点)
    - name: Install dependencies
      run: |
        sudo apt-get update
        # =================================================================
        #   在这里加入了 libprotobuf-dev，以解决新的编译错误
        sudo apt-get install -y build-essential cmake libssl-dev protobuf-compiler libgflags-dev libleveldb-dev libprotobuf-dev
        # =================================================================

    # 步骤5: 编译项目
    - name: Build project
      run: |
        cd source_code
        cmake .
        make -j2

    # 步骤6: 运行分析
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        output: ../results
        format: csv

    # 步骤7: 上传结果
    - name: Upload results as an artifact
      uses: actions/upload-artifact@v4
      with:
        name: codeql-feature-results
        path: ../results
